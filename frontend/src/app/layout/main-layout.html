<!-- Loading Overlay -->
<div class="loading-overlay" *ngIf="authService.isLoading()">
    <div class="loading-spinner">
        <mat-icon class="spinner-icon">refresh</mat-icon>
        <p>Loading...</p>
    </div>
</div>

<!-- Main Content -->
<div class="main-content" *ngIf="!authService.isLoading()">
    <!-- Top Navigation Bar -->
    <header class="top-nav">
        <div class="nav-left">
            <div class="logo"><img src="logo.png" alt="logo"></div>
        </div>

        <div class="nav-center">
            <a routerLink="/home" class="nav-tab" routerLinkActive="active" title="Feed">
                <i class="icon"><mat-icon>home</mat-icon></i>
            </a>
            <a routerLink="/notifications" class="nav-tab" routerLinkActive="active" title="Notifications"
                *ngIf="authService.isLoggedIn()">
                <div class="icon-with-badge">
                    <i class="icon"><mat-icon>notifications</mat-icon></i>
                    <span class="badge"
                        *ngIf="inAppNotificationService.unreadCount() > 0">{{inAppNotificationService.unreadCount()}}</span>
                </div>
            </a>
        </div>

        <div class="nav-right">
            <!-- Logged-in: avatar icon + dropdown -->
            <button class="user-menu-btn" *ngIf="authService.isLoggedIn(); else loggedOutButton"
                (click)="onProfileClick()">
                <mat-icon>account_box</mat-icon>
            </button>

            <!-- Not logged in: Login / Sign up button -->
            <ng-template #loggedOutButton>
                <button class="user-menu-btn" (click)="onProfileClick()">
                    <mat-icon>login</mat-icon>
                </button>
            </ng-template>

            <!-- User menu panel (only when logged in) -->
            <div class="user-menu-panel" *ngIf="authService.isLoggedIn() && showUserMenu()">
                <button class="user-menu-item" [routerLink]="['/block']">My Block</button>
                <button class="user-menu-item" (click)="onLogout()">Logout</button>
            </div>
        </div>
    </header>

    <div class="main-layout">
        <!-- Left Sidebar: Navigation & Profile -->
        <aside class="sidebar left-sidebar">
            <div class="profile-card" *ngIf="authService.isLoggedIn()">
                <img *ngIf="currentUser().avatarUrl" [src]="currentUser().avatarUrl" class="profile-avatar">
                <div *ngIf="!currentUser().avatarUrl" class="profile-avatar"
                    style="background: #e0e0e0; display: flex; align-items: center; justify-content: center;">
                    <mat-icon>account_circle</mat-icon>
                </div>
                <div class="profile-info">
                    <h3>{{currentUser().name}}</h3>
                    <p>{{currentUser().handle}}</p>
                </div>
            </div>

            <nav class="main-nav">
                <a routerLink="/home" class="nav-item" routerLinkActive="active">
                    <i class="icon"><mat-icon>home</mat-icon></i> Feed
                </a>
                <a routerLink="/block" class="nav-item" routerLinkActive="active" *ngIf="authService.isLoggedIn()">
                    <i class="icon"><mat-icon>account_circle</mat-icon></i> My Block
                </a>
                <a routerLink="/admin" class="nav-item admin-link"
                    *ngIf="authService.isLoggedIn() && authService.isAdmin()" routerLinkActive="active">
                    <i class="icon"><mat-icon>admin_panel_settings</mat-icon></i> Admin Panel
                </a>
            </nav>
        </aside>

        <!-- Center Column: Dynamic Content -->
        <main class="feed-container">
            <router-outlet></router-outlet>
        </main>

        <!-- Right Sidebar: Suggestions & Following -->
        <aside class="sidebar right-sidebar">
            <div class="suggestions-container">
                <!-- Suggestions Section -->
                <div class="sidebar-section">
                    <h3>Who to follow</h3>
                    <div class="scrollable-list">
                        <div class="user-suggestion-card" *ngFor="let user of suggestedUsers()">
                            <div class="user-info" (click)="viewUserProfile(user.username)">
                                <img *ngIf="user.avatarUrl" [src]="user.avatarUrl" class="suggestion-avatar">
                                <div *ngIf="!user.avatarUrl" class="suggestion-avatar-placeholder">
                                    <mat-icon>account_circle</mat-icon>
                                </div>
                                <div class="suggestion-details">
                                    <h4>{{ user.username }}</h4>
                                    <p>@{{ user.username }}</p>
                                </div>
                            </div>
                            <button class="suggestion-follow-btn" [class.following]="isUserFollowed(user.id)"
                                (click)="onFollowSuggestedUser(user)">
                                {{ isUserFollowed(user.id) ? 'Unfollow' : 'Follow' }}
                            </button>
                        </div>

                        <div *ngIf="suggestedUsers().length === 0" class="no-suggestions">
                            <p>No suggestions available</p>
                        </div>
                    </div>
                </div>

                <!-- Following Section -->
                <div class="sidebar-section" *ngIf="followingUsers().length > 0">
                    <h3>Following</h3>
                    <div class="scrollable-list">
                        <div class="user-suggestion-card" *ngFor="let user of followingUsers()">
                            <div class="user-info" (click)="viewUserProfile(user.username)">
                                <img *ngIf="user.avatarUrl" [src]="user.avatarUrl" class="suggestion-avatar">
                                <div *ngIf="!user.avatarUrl" class="suggestion-avatar-placeholder">
                                    <mat-icon>account_circle</mat-icon>
                                </div>
                                <div class="suggestion-details">
                                    <h4>{{ user.username }}</h4>
                                    <p>@{{ user.username }}</p>
                                </div>
                            </div>
                            <button class="suggestion-follow-btn following" (click)="onFollowSuggestedUser(user)">
                                Unfollow
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Bottom Navigation Bar (Mobile only) -->
    <nav class="bottom-nav">
        <a routerLink="/home" class="bottom-nav-item" routerLinkActive="active">
            <mat-icon>home</mat-icon>
            <span>Home</span>
        </a>
        <a routerLink="/notifications" class="bottom-nav-item" routerLinkActive="active"
            *ngIf="authService.isLoggedIn()">
            <div class="icon-with-badge">
                <mat-icon>notifications</mat-icon>
                <span class="badge"
                    *ngIf="inAppNotificationService.unreadCount() > 0">{{inAppNotificationService.unreadCount()}}</span>
            </div>
            <span>Alerts</span>
        </a>
        <a routerLink="/block" class="bottom-nav-item" routerLinkActive="active" *ngIf="authService.isLoggedIn()">
            <mat-icon>account_circle</mat-icon>
            <span>Profile</span>
        </a>
        <a routerLink="/discover" class="bottom-nav-item" routerLinkActive="active" *ngIf="authService.isLoggedIn()">
            <mat-icon>explore</mat-icon>
            <span>Discover</span>
        </a>
        <a routerLink="/admin" class="bottom-nav-item" routerLinkActive="active"
            *ngIf="authService.isLoggedIn() && authService.isAdmin()">
            <mat-icon>admin_panel_settings</mat-icon>
            <span>Admin</span>
        </a>
    </nav>

    <!-- Media Lightbox Overlay -->
    <div class="lightbox-overlay" *ngIf="lightboxService.isOpen()" (click)="closeLightbox()">
        <button class="close-lightbox" (click)="closeLightbox()">
            <mat-icon>close</mat-icon>
        </button>
        <div class="lightbox-content" (click)="$event.stopPropagation()">
            <img *ngIf="lightboxService.data()?.type === 'IMAGE'" [src]="lightboxService.data()?.url"
                alt="Enlarged media">
            <video *ngIf="lightboxService.data()?.type === 'VIDEO'" [src]="lightboxService.data()?.url" controls
                autoplay></video>
        </div>
    </div>
</div>