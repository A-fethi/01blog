<!-- Loading Overlay - Shows while auth is loading -->
<div class="loading-overlay" *ngIf="authService.isLoading()">
  <div class="loading-spinner">
    <mat-icon class="spinner-icon">refresh</mat-icon>
    <p>Loading...</p>
  </div>
</div>

<!-- Main Content - Only shown when not loading -->
<div class="main-content" *ngIf="!authService.isLoading()">
  <!-- Top Navigation Bar -->
  <header class="top-nav">
    <div class="nav-left">
      <div class="logo">01</div>
      <div class="search-bar">
        <i class="icon"><mat-icon>search</mat-icon></i>
        <input type="text" placeholder="Search 01Blog">
      </div>
    </div>

    <div class="nav-center">
      <a href="#" class="nav-tab active" title="Feed">
        <i class="icon"><mat-icon color="red">home</mat-icon></i>
      </a>
      <a href="#" class="nav-tab" title="Notifications" *ngIf="authService.isLoggedIn()">
        <i class="icon"><mat-icon>notifications</mat-icon></i>
      </a>
      <a href="#" class="nav-tab" title="Messages" *ngIf="authService.isLoggedIn()">
        <i class="icon"><mat-icon>question_answer</mat-icon></i>
      </a>
    </div>

    <div class="nav-right">
      <!-- Logged-in: avatar icon + dropdown -->
      <button class="user-menu-btn" *ngIf="authService.isLoggedIn(); else loggedOutButton" (click)="onProfileClick()">
        <mat-icon>account_box</mat-icon>
      </button>

      <!-- Not logged in: Login / Sign up button -->
      <ng-template #loggedOutButton>
        <button class="user-menu-btn" (click)="onProfileClick()">
          Login / Sign up
        </button>
      </ng-template>

      <!-- User menu panel (only when logged in) -->
      <div class="user-menu-panel" *ngIf="authService.isLoggedIn() && showUserMenu()">
        <button class="user-menu-item" [routerLink]="['/block']">My Block</button>
        <button class="user-menu-item" (click)="onLogout()">Logout</button>
      </div>
    </div>
  </header>

  <div class="home-container">
    <!-- Left Sidebar: Navigation & Profile -->
    <aside class="sidebar left-sidebar">
      <div class="profile-card">
        <img *ngIf="currentUser().avatarUrl" [src]="currentUser().avatarUrl" class="avatar">
        <div *ngIf="!currentUser().avatarUrl" class="avatar-placeholder">
          <mat-icon>account_circle</mat-icon>
        </div>
        <div class="profile-info">
          <h3>{{currentUser().name}}</h3>
          <p>{{currentUser().handle}}</p>
        </div>
      </div>

      <nav class="main-nav">
        <a href="#" class="nav-item active">
          <i class="icon"><mat-icon>home</mat-icon></i> Feed
        </a>
        <a href="/block" class="nav-item">
          <i class="icon"><mat-icon>account_circle</mat-icon></i> My Block
        </a>
        <a href="#" class="nav-item">
          <i class="icon"><mat-icon>diversity_3</mat-icon></i> Subscriptions
        </a>
        <a href="#" class="nav-item">
          <i class="icon"><mat-icon>settings</mat-icon></i> Settings
        </a>
        <a routerLink="/admin" class="nav-item admin-link" *ngIf="authService.isLoggedIn() && authService.isAdmin()">
          <i class="icon"><mat-icon>admin_panel_settings</mat-icon></i> Admin Panel
        </a>
      </nav>
    </aside>

    <!-- Center Column: Feed -->
    <main class="feed-container">
      <!-- Create Post Widget -->
      <div class="create-post-card">
        <div class="create-post-top">
          <img *ngIf="currentUser().avatarUrl" [src]="currentUser().avatarUrl" class="avatar">
          <div *ngIf="!currentUser().avatarUrl" class="avatar-placeholder">
            <mat-icon>account_circle</mat-icon>
          </div>
          <!-- <img [src]="currentUser().avatarUrl || 'assets/default-avatar.png'" class="user-avatar-small"> -->
          <input type="text"
            [placeholder]="authService.isLoggedIn() ? 'Share your learning journey' : 'You must log in to post'"
            [ngModel]="newPostContent()" (ngModelChange)="newPostContent.set($event)"
            [disabled]="!authService.isLoggedIn()" />
          <button class="share-post-btn" (click)="onSharePost()">Share</button>
        </div>
        <div class="create-post-actions">
          <button class="action-btn">
            <i class="icon"><mat-icon>add_photo_alternate</mat-icon></i> Media
          </button>
        </div>
      </div>

      <!-- Posts Feed -->
      <div class="posts-list">
        <div *ngIf="loading()" class="loading-feed">
          <mat-icon class="spin">refresh</mat-icon> Loading feed...
        </div>

        <div class="post-card" *ngFor="let post of posts()">
          <div class="post-header">
            <img *ngIf="currentUser().avatarUrl" [src]="currentUser().avatarUrl" class="avatar">
            <div *ngIf="!currentUser().avatarUrl" class="avatar-placeholder">
              <mat-icon>account_circle</mat-icon>
            </div>
            <div class="post-meta">
              <h4>{{post.author?.username}}</h4>
              <span class="timestamp">{{post.createdAt | date:'short'}}</span>
            </div>
            <button class="more-options"><mat-icon>more_horiz</mat-icon></button>
          </div>

          <div class="post-content">
            <p>{{post.content}}</p>
            <div *ngIf="post.mediaUrl" class="post-media">
              <img *ngIf="post.mediaType === 'IMAGE'" [src]="post.mediaUrl">
              <video *ngIf="post.mediaType === 'VIDEO'" [src]="post.mediaUrl" controls></video>
            </div>
          </div>

          <div class="post-stats">
            <span>{{post.likeCount || 0}} Likes</span>
            <span>{{post.commentCount || 0}} Comments</span>
          </div>

          <div class="post-actions">
            <button class="action-btn" (click)="onLike(post)" [class.liked]="post.isLiked">
              <i class="icon">
                <mat-icon>{{post.isLiked ? 'favorite' : 'favorite_border'}}</mat-icon>
              </i>
              Like
            </button>
            <button class="action-btn" (click)="toggleComments(post.id)">
              <i class="icon"><mat-icon>comment</mat-icon></i> Comment
            </button>
          </div>

          <!-- Comments section (visible to everyone) -->
          <div class="comments-section" *ngIf="showComments().has(post.id)">
            <div class="comment-item" *ngFor="let c of post.comments">
              <div class="comment-author">{{ c.commentUsername }}</div>
              <div class="comment-text">{{ c.content }}</div>
              <div class="comment-time">{{ c.createdAt | date:'short' }}</div>
            </div>

            <!-- Comment input only for logged-in users -->
            <div class="add-comment" *ngIf="authService.isLoggedIn(); else loginToComment">
              <input type="text" placeholder="Write a comment..." [ngModel]="getCommentInput(post.id)"
                (ngModelChange)="setCommentInput(post.id, $event)" (keyup.enter)="onSubmitComment(post.id)" />
              <button class="comment-submit-btn" (click)="onSubmitComment(post.id)">
                Comment
              </button>
            </div>

            <!-- Message for guests -->
            <ng-template #loginToComment>
              <div class="login-to-comment">
                Log in to add a comment.
              </div>
            </ng-template>
          </div>
        </div>
      </div>
    </main>

    <!-- Right Sidebar: Suggestions -->
    <aside class="sidebar right-sidebar">
      <div class="suggestions-container">
        <h3>Who to follow</h3>
        <div class="suggestion-list">
          <!-- TODO: Implement suggestions -->
          <div class="suggestion-item">
            <p>Suggestions coming soon...</p>
          </div>
        </div>
      </div>
    </aside>
  </div>
</div>