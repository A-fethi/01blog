<div class="block-container">
    <!-- Profile Header -->
    <div class="profile-header" *ngIf="profileUser()">
        <div class="cover-photo"></div>
        <div class="profile-main">
            <div class="profile-top">
                <div class="avatar-container">
                    <img *ngIf="profileUser()?.avatarUrl" [src]="profileUser()?.avatarUrl" class="profile-avatar">
                    <div *ngIf="!profileUser()?.avatarUrl" class="profile-avatar-placeholder">
                        <mat-icon>account_circle</mat-icon>
                    </div>
                </div>
                <div class="profile-actions">
                    <button *ngIf="isOwnProfile() && !editingProfile()" class="edit-profile-btn"
                        (click)="onEditProfile()">
                        Edit Profile
                    </button>
                    <div class="guest-actions" *ngIf="!isOwnProfile()">
                        <button class="follow-btn" [class.following]="isFollowing()" (click)="onFollowToggle()">
                            {{ isFollowing() ? 'Following' : 'Follow' }}
                        </button>
                        <button class="report-profile-btn" (click)="onReportUser()"
                            *ngIf="authService.isLoggedIn() && !authService.isAdmin()" title="Report Profile">
                            <mat-icon>flag</mat-icon>
                        </button>
                    </div>
                </div>
            </div>

            <div class="profile-info" *ngIf="!editingProfile()">
                <h2 class="profile-name">{{ profileUser()?.username }}</h2>
                <p class="profile-handle">@{{ profileUser()?.username }}</p>
                <div class="profile-stats">
                    <div class="stat-item" (click)="openFollowersModal()">
                        <span class="stat-value">{{ followersCount() }}</span>
                        <span class="stat-label">Followers</span>
                    </div>
                    <div class="stat-item" (click)="openFollowingModal()">
                        <span class="stat-value">{{ followingCount() }}</span>
                        <span class="stat-label">Following</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">{{ postsCount() }}</span>
                        <span class="stat-label">Posts</span>
                    </div>
                </div>
            </div>

            <!-- Edit Profile Form -->
            <div class="edit-profile-form" *ngIf="editingProfile()">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" [ngModel]="editUsername()" (ngModelChange)="editUsername.set($event)">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" [ngModel]="editEmail()" (ngModelChange)="editEmail.set($event)">
                </div>
                <div class="form-group">
                    <label>Avatar</label>
                    <input type="file" (change)="onAvatarSelected($event)" accept="image/*">
                </div>
                <div class="edit-actions">
                    <button class="save-btn" (click)="onUpdateProfile()">Save Changes</button>
                    <button class="delete-profile-btn" (click)="onDeleteProfile()">Delete Profile</button>
                    <button class="cancel-btn" (click)="onCancelEditProfile()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Posts Feed -->
    <div class="posts-feed">
        <div *ngIf="loading()" class="loading-state">
            <mat-icon class="spin">refresh</mat-icon>
            <p>Loading posts...</p>
        </div>

        <div *ngIf="!loading() && userPosts().length === 0" class="empty-state">
            <mat-icon>post_add</mat-icon>
            <h3>No posts yet</h3>
            <p *ngIf="isOwnProfile()">Share your first post to get started!</p>
            <p *ngIf="!isOwnProfile()">This user hasn't posted anything yet.</p>
        </div>

        <div class="post-card" *ngFor="let post of userPosts()">
            <div class="post-header">
                <img *ngIf="post.authorAvatarUrl" [src]="post.authorAvatarUrl" class="avatar">
                <div *ngIf="!post.authorAvatarUrl" class="avatar-placeholder">
                    <mat-icon>account_circle</mat-icon>
                </div>
                <div class="post-meta">
                    <h4>{{ post.authorUsername }}</h4>
                    <span class="timestamp">{{ post.createdAt | date:'short' }}</span>
                </div>

                <div class="post-actions-menu" *ngIf="authService.isLoggedIn()">
                    <button class="more-options" (click)="post.showMenu = !post.showMenu">
                        <mat-icon>more_horiz</mat-icon>
                    </button>
                    <div class="menu-dropdown" *ngIf="post.showMenu">
                        <ng-container *ngIf="post.authorId === authService.currentUser()?.id">
                            <button (click)="onEditPost(post); post.showMenu = false">Edit</button>
                            <button (click)="onDeletePost(post.id); post.showMenu = false"
                                class="delete-btn">Delete</button>
                        </ng-container>

                        <!-- Admin Options (if not owner) -->
                        <button *ngIf="authService.isAdmin() && post.authorId !== authService.currentUser()?.id"
                            (click)="onDeletePost(post.id); post.showMenu = false" class="delete-btn">Delete</button>

                        <!-- Report Option (if not owner and not admin) -->
                        <button *ngIf="!authService.isAdmin() && post.authorId !== authService.currentUser()?.id"
                            (click)="onReportPost(post); post.showMenu = false">Report</button>

                    </div>
                </div>
            </div>

            <div class="post-content" *ngIf="editingPostId() !== post.id">
                <h3 *ngIf="post.title && post.title !== 'Untitled Post'" class="post-title">{{ post.title }}</h3>
                <p>{{ post.content }}</p>
                <div *ngIf="post.mediaUrl" class="post-media">
                    <img *ngIf="post.mediaType === 'IMAGE'" [src]="post.mediaUrl" class="clickable-media"
                        (click)="openLightbox(post.mediaUrl, 'IMAGE')">
                    <video *ngIf="post.mediaType === 'VIDEO'" [src]="post.mediaUrl" controls class="clickable-media"
                        (click)="openLightbox(post.mediaUrl, 'VIDEO')"></video>
                </div>
            </div>

            <!-- Edit Post Form -->
            <div class="edit-post-form" *ngIf="editingPostId() === post.id">
                <input type="text" [ngModel]="editPostTitle()" (ngModelChange)="editPostTitle.set($event)"
                    placeholder="Title">
                <textarea [ngModel]="editPostContent()" (ngModelChange)="editPostContent.set($event)"
                    placeholder="Content"></textarea>
                <div class="edit-actions">
                    <button class="save-btn" (click)="onUpdatePost()">Save</button>
                    <button class="cancel-btn" (click)="onCancelEditPost()">Cancel</button>
                </div>
            </div>

            <div class="post-stats">
                <span>{{ post.likesCount || 0 }} Likes</span>
                <span>{{ post.commentsCount || 0 }} Comments</span>
            </div>

            <div class="post-actions">
                <button class="action-btn" (click)="onLike(post)" [class.liked]="post.isLiked">
                    <i class="icon">
                        <mat-icon>{{ post.isLiked ? 'favorite' : 'favorite_border' }}</mat-icon>
                    </i>
                    Like
                </button>
                <button class="action-btn" (click)="toggleComments(post.id)">
                    <i class="icon"><mat-icon>comment</mat-icon></i> Comment
                </button>
            </div>

            <!-- Comments section -->
            <div class="comments-section" *ngIf="showComments().has(post.id)">
                <div class="comment-item" *ngFor="let c of post.comments">
                    <div class="comment-header">
                        <div class="comment-author">{{ c.commentUsername }}</div>
                        <div class="comment-actions"
                            *ngIf="authService.isLoggedIn() && c.commentUsername === authService.currentUser()?.username">
                            <button (click)="onEditComment(c)">Edit</button>
                            <button (click)="onDeleteComment(post.id, c.id)" class="delete-btn">Delete</button>
                        </div>
                    </div>

                    <div class="comment-body" *ngIf="editingCommentId() !== c.id">
                        <div class="comment-text">{{ c.content }}</div>
                        <div class="comment-time">{{ c.createdAt | date:'short' }}</div>
                    </div>

                    <!-- Edit Comment Form -->
                    <div class="edit-comment-form" *ngIf="editingCommentId() === c.id">
                        <textarea [ngModel]="editCommentContent()"
                            (ngModelChange)="editCommentContent.set($event)"></textarea>
                        <div class="edit-actions">
                            <button class="save-btn" (click)="onUpdateComment(post.id)">Save</button>
                            <button class="cancel-btn" (click)="onCancelEditComment()">Cancel</button>
                        </div>
                    </div>
                </div>

                <div class="add-comment" *ngIf="authService.isLoggedIn()">
                    <input type="text" placeholder="Write a comment..." [ngModel]="getCommentInput(post.id)"
                        (ngModelChange)="setCommentInput(post.id, $event)" (keyup.enter)="onSubmitComment(post.id)" />
                    <button class="comment-submit-btn" (click)="onSubmitComment(post.id)">
                        Comment
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<app-user-list-modal *ngIf="showModal()" [title]="modalTitle()" [users]="modalUsers()" (close)="closeModal()">
</app-user-list-modal>

<app-confirm-modal *ngIf="showConfirmModal()" [title]="confirmModalTitle()" [message]="confirmModalMessage()"
    (confirm)="onConfirmAction()" (cancel)="onCancelConfirm()">
</app-confirm-modal>